# ğŸ”‘ Access Codes Setup Guide - FIX SECRET CODE ISSUE

## â— PROBLEM: Secret Codes Don't Work

If access codes don't work when creating accounts, it's because:
- **Manager**: Needs `admin123` (works immediately)
- **Field Officer & Finance**: Need active codes in database (must be generated first)

---

## âœ… SOLUTION: Proper Setup Sequence

### **Option 1: Quick Fix (Recommended)**

#### **Step 1: Run Seed Script**
This creates initial codes for first-time setup:

```bash
cd backend
npm run seed:codes
```

**This will create:**
- Field Officer code: `INITIAL_FO_2024`
- Finance Manager code: `INITIAL_FIN_2024`
- Manager continues to use: `admin123`

#### **Step 2: Register Accounts**

Now you can register with these codes:

**Manager:**
```
Code: admin123
```

**Field Officer:**
```
Code: INITIAL_FO_2024
```

**Finance Manager:**
```
Code: INITIAL_FIN_2024
```

---

### **Option 2: Proper Workflow (Production)**

#### **Step 1: Create Manager Account First**
```
1. Go to Registration Page
2. Select Role: Manager
3. Enter Access Code: admin123
4. Complete registration
5. âœ… Manager account created!
```

#### **Step 2: Login as Manager**
```
1. Login with manager credentials
2. Manager dashboard loads
3. Find "Access Codes" card
```

#### **Step 3: Generate Dynamic Codes**
```
1. In Access Codes card
2. Click "New" button for Field Officer
3. Code generated (e.g., A1B2C3D4)
4. Copy the code
5. Click "New" button for Finance Manager
6. Code generated (e.g., E5F6G7H8)
7. Copy the code
```

#### **Step 4: Register Field Officer & Finance**
```
Use the generated codes to register:
- Field Officer: Use the code from step 3
- Finance Manager: Use the code from step 3
```

---

## ğŸ“‹ Access Codes Explained

### **Manager Code:**
- **Type**: Static Admin Secret
- **Code**: `admin123`
- **Source**: `.env` file (ADMIN_SECRET)
- **Expires**: Never
- **Usage**: Unlimited

### **Field Officer & Finance Codes:**
- **Type**: Dynamic One-Time Codes
- **Code**: Random 8-char (e.g., A1B2C3D4)
- **Source**: Database (generated by manager)
- **Expires**: After first use OR 24 hours
- **Usage**: One-time only

---

## ğŸš€ Quick Start Commands

### **Initialize Access Codes (First Time):**
```bash
cd backend
npm run seed:codes
```

### **Start Backend:**
```bash
cd backend
npm run dev
```

### **Start Frontend:**
```bash
cd frontend
npm run dev
```

---

## ğŸ¯ Registration Codes Reference

| Role | Code | Where to Get It |
|------|------|-----------------|
| **Manager** | `admin123` | Always available (from .env) |
| **Field Officer** | `INITIAL_FO_2024` | Run seed script OR generate in dashboard |
| **Finance Manager** | `INITIAL_FIN_2024` | Run seed script OR generate in dashboard |

---

## ğŸ” Troubleshooting

### **Error: "Invalid or expired access code"**

**For Manager:**
```
âŒ Problem: Using wrong admin secret
âœ… Solution: Use exactly "admin123" (no spaces)
```

**For Field Officer / Finance:**
```
âŒ Problem: No active codes in database
âœ… Solution: 
   Option 1: Run "npm run seed:codes"
   Option 2: Login as manager and generate new code
```

### **Error: "Access code has expired"**

**Cause**: Code was already used by someone else

**Solution:**
```
1. Login as Manager
2. Generate new code
3. Use the new code immediately
```

### **Seed Script Not Working:**

```bash
# Make sure you're in the backend folder
cd backend

# Make sure backend is running
npm run dev

# In another terminal, run seed:
npm run seed:codes
```

---

## ğŸ“Š Visual Guide

### **Access Codes Card (Manager Dashboard):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”‘ Access Codes                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ‘¥ Field Officer        [ğŸ“‹] [New]   â”‚
â”‚ Status: Active / No code               â”‚
â”‚ A1B2C3D4 or "No active code"          â”‚
â”‚ âš ï¸ Expires after first use            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“ˆ Finance Manager      [ğŸ“‹] [New]   â”‚
â”‚ Status: Active / No code               â”‚
â”‚ E5F6G7H8 or "No active code"          â”‚
â”‚ âš ï¸ Expires after first use            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ›¡ï¸ Manager (Admin)      [ğŸ“‹]         â”‚
â”‚ Status: Admin Secret                  â”‚
â”‚ admin123                              â”‚
â”‚ ğŸ”’ Permanent admin secret             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¡ Best Practices

### **For Initial Setup:**
1. âœ… Run seed script ONCE
2. âœ… Create manager account
3. âœ… Generate fresh codes for each new user
4. âœ… Don't reuse codes

### **For Production:**
1. âœ… Change `admin123` in .env file
2. âœ… Use `ADMIN_SECRET=your_secure_secret_here`
3. âœ… Restart backend after .env changes
4. âœ… Generate new codes for each registration

---

## ğŸ§ª Test Registration Flow

### **Test 1: Manager Registration**
```
1. Go to: http://localhost:3000/register
2. Fill form:
   - Name: Test Manager
   - Email: manager@test.com
   - Password: Test1234
   - Role: Manager
   - Access Code: admin123
3. Click Register
4. âœ… Should succeed and redirect to dashboard
```

### **Test 2: Field Officer (After Seed)**
```
1. Run: npm run seed:codes (in backend folder)
2. Go to: http://localhost:3000/register
3. Fill form:
   - Role: Field Officer
   - Access Code: INITIAL_FO_2024
4. Click Register
5. âœ… Should succeed
```

### **Test 3: Dynamic Code (After Manager Login)**
```
1. Login as manager
2. Go to Access Codes card
3. Click "New" for Field Officer
4. Copy generated code
5. Logout
6. Register new Field Officer with that code
7. âœ… Should succeed
8. Try to reuse same code
9. âŒ Should fail (already used)
```

---

## ğŸ“ Checklist

Before registering accounts, ensure:

- [ ] Backend is running (`npm run dev`)
- [ ] Frontend is running (`npm run dev`)
- [ ] MongoDB is running
- [ ] `.env` file has `ADMIN_SECRET=admin123`
- [ ] For first time: Run `npm run seed:codes`
- [ ] For Manager: Use `admin123`
- [ ] For Field Officer/Finance: Use seeded codes OR generate new ones

---

## ğŸ¯ Summary

**The Issue:**
- Access codes need to exist in database before use
- Manager uses static admin secret (always works)
- Field Officer & Finance need active database codes

**The Fix:**
1. **Quick**: Run `npm run seed:codes`
2. **Or**: Create manager first, then generate codes
3. **Then**: Register other accounts with codes

**Remember:**
- Manager code: `admin123` (permanent)
- Other codes: Must be generated or seeded
- Codes expire after first use

---

## ğŸ†˜ Still Not Working?

### **Check Backend Logs:**
```bash
# Look for error messages when registering
# Should show validation errors
```

### **Check Database:**
```bash
# Connect to MongoDB
mongosh

# Switch to database
use fmis

# Check access codes
db.access_codes.find().pretty()

# Should show codes with status: 'active'
```

### **Common Issues:**
1. âŒ Backend not running â†’ Start with `npm run dev`
2. âŒ Wrong code format â†’ Check for typos/spaces
3. âŒ Code already used â†’ Generate new one
4. âŒ No codes in DB â†’ Run seed script

---

**After running the seed script, you can register accounts immediately!** ğŸš€âœ…

**Last Updated:** November 6, 2024
**Issue:** Secret codes don't work
**Solution:** Run seed script or generate codes as manager
